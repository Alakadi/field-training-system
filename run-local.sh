#!/bin/bash

# ูุธุงู ุฅุฏุงุฑุฉ ุงูุชุฏุฑูุจ ุงูููุฏุงูู - ุณูุฑูุจุช ุงูุชุดุบูู ุงููุญูู
# ูุชุดุบูู ุงููุธุงู ุนูู ุงููููุฐ 8080 ูุญููุงู

echo "๐ ุจุฏุก ุชุดุบูู ูุธุงู ุฅุฏุงุฑุฉ ุงูุชุฏุฑูุจ ุงูููุฏุงูู ูุญููุงู..."

# ุงูุชุญูู ูู ูุฌูุฏ Node.js
if ! command -v node &> /dev/null; then
    echo "โ Node.js ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช Node.js ุฃููุงู."
    exit 1
fi

# ุงูุชุญูู ูู ูุฌูุฏ npm
if ! command -v npm &> /dev/null; then
    echo "โ npm ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช npm ุฃููุงู."
    exit 1
fi

# ุงูุชุญูู ูู ูุฌูุฏ PostgreSQL
if ! command -v psql &> /dev/null; then
    echo "โ PostgreSQL ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช PostgreSQL ุฃููุงู."
    exit 1
fi

# ุงูุชุญูู ูู ููู .env
if [ ! -f .env ]; then
    echo "โ๏ธ  ููู .env ุบูุฑ ููุฌูุฏ. ุฅูุดุงุก ููู .env ูู ุงููุซุงู..."
    if [ -f .env.example ]; then
        cp .env.example .env
        echo "โ ุชู ุฅูุดุงุก ููู .env. ูุฑุฌู ุชุญุฏูุซ ูุนูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช."
    else
        echo "โ ููู .env.example ุบูุฑ ููุฌูุฏ. ูุฑุฌู ุฅูุดุงุก ููู .env ูุฏููุงู."
        exit 1
    fi
fi

# ุชุญููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

# ุชุนููู ุงููููุฐ ุฅูู 8080 ุฅุฐุง ูู ููู ูุญุฏุฏุงู
if [ -z "$PORT" ]; then
    export PORT=8080
fi

echo "๐ ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช..."

# ุงูุชุญูู ูู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
if [ ! -z "$DATABASE_URL" ]; then
    echo "โ ูุชุบูุฑ DATABASE_URL ููุฌูุฏ"
else
    echo "โ ูุชุบูุฑ DATABASE_URL ุบูุฑ ููุฌูุฏ ูู ููู .env"
    exit 1
fi

echo "๐ฆ ุชุซุจูุช ุงูุชุจุนูุงุช..."
npm install

echo "๐๏ธ  ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช..."

# ุชุดุบูู ุณูุฑูุจุช ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช
if [ -f "scripts/db-push.js" ]; then
    node scripts/db-push.js
    if [ $? -ne 0 ]; then
        echo "โ ูุดู ูู ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช"
        exit 1
    fi
else
    echo "โ ููู scripts/db-push.js ุบูุฑ ููุฌูุฏ"
    exit 1
fi

echo "๐ฑ ุฅุถุงูุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ..."

# ุชุดุบูู ุณูุฑูุจุชุงุช ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
if [ -f "scripts/setup-local.js" ]; then
    npx tsx scripts/setup-local.js
    if [ $? -ne 0 ]; then
        echo "โ๏ธ  ุชุญุฐูุฑ: ูุดู ูู ุฅุถุงูุฉ ุจุนุถ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ"
    fi
fi

echo ""
echo "๐ ุชู ุฅุนุฏุงุฏ ุงููุธุงู ุจูุฌุงุญ!"
echo ""
echo "ูุนูููุงุช ุชุณุฌูู ุงูุฏุฎูู:"
echo "ุงููุณุคูู: admin / admin123"
echo ""
echo "๐ ุณูุนูู ุงูุชุทุจูู ุนูู: http://localhost:$PORT"
echo ""
echo "๐ ุจุฏุก ุชุดุบูู ุงูุฎุงุฏู..."

# ุชุดุบูู ุงูุชุทุจูู
NODE_ENV=development tsx server/index.ts

import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import bcrypt from 'bcrypt';
import * as schema from '../shared/schema.ts';

async function hashExistingPasswords() {
  const databaseUrl = process.env.DATABASE_URL;
  
  if (!databaseUrl) {
    console.error('âŒ Ù…ØªØºÙŠØ± DATABASE_URL ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ù„Ù .env');
    process.exit(1);
  }

  const sql = postgres(databaseUrl);
  const db = drizzle(sql, { schema });

  try {
    console.log('ğŸ” Ø¨Ø¯Ø¡ ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©...');

    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    const users = await db.select().from(schema.users);
    
    for (const user of users) {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø´ÙØ±Ø© (Ø·ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´ÙØ±Ø© Ù…Ø¹ bcrypt Ø¹Ø§Ø¯Ø© 60 Ø­Ø±Ù)
      if (user.password.length < 60) {
        console.log(`ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.username}`);
        
        // ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const hashedPassword = await bcrypt.hash(user.password, 10);
        
        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await db.update(schema.users)
          .set({ password: hashedPassword })
          .where(schema.users.id.eq(user.id));
          
        console.log(`âœ… ØªÙ… ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.username}`);
      } else {
        console.log(`â­ï¸  ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user.username} Ù…Ø´ÙØ±Ø© Ø¨Ø§Ù„ÙØ¹Ù„`);
      }
    }

    console.log('âœ… ØªÙ… ØªØ´ÙÙŠØ± Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±:', error);
  } finally {
    await sql.end();
    process.exit(0);
  }
}

hashExistingPasswords();
